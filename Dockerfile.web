# Usa l'immagine ufficiale di Nginx come base
FROM nginx:latest

# Crea il file di configurazione nginx.conf direttamente all'interno del container
# Questo approccio garantisce che non ci siano conflitti di file system
RUN echo "events { worker_connections 1024; }" > /etc/nginx/nginx.conf \
    && echo "http {" >> /etc/nginx/nginx.conf \
    && echo "    server {" >> /etc/nginx/nginx.conf \
    && echo "        listen 80;" >> /etc/nginx/nginx.conf \
    && echo "        root /usr/share/nginx/html;" >> /etc/nginx/nginx.conf \
    && echo "        index login.html index.html;" >> /etc/nginx/nginx.conf \
    && echo "        location /api {" >> /etc/nginx/nginx.conf \
    && echo "            proxy_pass http://backend:5000;" >> /etc/nginx/nginx.conf \
    && echo "            proxy_set_header Host \$host;" >> /etc/nginx/nginx.conf \
    && echo "            proxy_set_header X-Real-IP \$remote_addr;" >> /etc/nginx/nginx.conf \
    && echo "            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;" >> /etc/nginx/nginx.conf \
    && echo "        }" >> /etc/nginx/nginx.conf \
    && echo "        location / {" >> /etc/nginx/nginx.conf \
    && echo "            try_files \$uri \$uri/ =404;" >> /etc/nginx/nginx.conf \
    && echo "        }" >> /etc/nginx/nginx.conf \
    && echo "    }" >> /etc/nginx/nginx.conf \
    && echo "}" >> /etc/nginx/nginx.conf

# Rimuovi il file di configurazione predefinito di Nginx
# Questo previene qualsiasi potenziale conflitto
RUN rm /etc/nginx/conf.d/default.conf

# Copia l'intera cartella 'client' nel percorso di Nginx
COPY ./client /usr/share/nginx/html

# Avvia Nginx usando la nostra configurazione principale
CMD ["nginx", "-c", "/etc/nginx/nginx.conf", "-g", "daemon off;"]